<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Attendance System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@400;500&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:"Poppins",sans-serif;
  background:linear-gradient(135deg, rgba(10,0,25,.9), rgba(0,10,30,.92));
  color:#eaffff;
}
.container{
  margin:14px;
  padding:22px;
  border-radius:26px;
  background:rgba(8,8,20,.65);
  border:1px solid rgba(0,255,255,.25);
}
h1{
  text-align:center;
  font-family:"Playfair Display",serif;
  letter-spacing:3px;
}
h2{
  text-align:center;
  font-size:13px;
  letter-spacing:4px;
  color:#9befff;
}
label{
  font-size:11px;
  letter-spacing:1px;
  color:#ff7cff;
}
input{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:8px;
  background:#000;
  color:#eaffff;
  border:1px solid #00eaff;
}
button{
  width:100%;
  padding:14px;
  border-radius:28px;
  letter-spacing:3px;
  cursor:pointer;
  background:linear-gradient(120deg,#ff00cc,#00eaff,#ff00cc);
  color:#000;
}
.log{margin-top:26px;}
.log-table{
  max-height:300px;
  overflow-y:auto;
  border-top:1px solid rgba(0,255,255,.25);
}
.log-row{
  display:grid;
  grid-template-columns:40px 100px 80px 90px 80px 80px 140px;
  gap:6px;
  padding:8px;
  font-size:12px;
  border-bottom:1px solid rgba(0,255,255,.15);
}
.log-head{
  font-weight:bold;
  position:sticky;
  top:0;
  background:#000;
}
.status.present::before{content:"âœ”";color:#00ff99}
.status.absent::before{content:"âœ–";color:#ff4d4d}

/* STATUS BAR */
.status-bar{
  width:100%;
  height:14px;
  background:#222;
  border-radius:20px;
  overflow:hidden;
  margin:10px 0;
}
#progressBar{
  height:100%;
  width:0%;
  transition:width .5s ease;
}
.bar-bad{background:#ff4d4d;}
.bar-good{background:#ffd24d;}
.bar-very-good{background:#4da6ff;}
.bar-complete{
  background:#00ff99;
  box-shadow:0 0 8px rgba(0,255,153,.8);
}
</style>
</head>

<body>

<div class="container">
<h1>VELOCITY SOCIETY CLUB</h1>
<h2>VSC CLUB ATTENDANCE</h2>

<label>NAME</label>
<input id="name">

<label>CPM ID</label>
<input id="cpm">

<label>DATE</label>
<input id="date" readonly>

<label>TIME</label>
<input id="time" readonly>

<label>ABSENT</label>
<input id="absent" placeholder="YES if absent">

<label>REASON</label>
<input id="reason">

<button onclick="confirmEntry()">CONFIRM</button>

<div class="log">

<div style="text-align:center">
  <h3 id="countDisplay">0 / 0 Members</h3>
  <h4 id="rateDisplay">BAD</h4>
</div>

<div class="status-bar">
  <div id="progressBar"></div>
</div>

<div>
  <strong>ABSENT MEMBERS:</strong>
  <ul id="absentList"></ul>
</div>

<h3>LIVE LOG</h3>
<div class="log-table">
  <div class="log-row log-head">
    <div></div><div>NAME</div><div>CPM</div><div>DATE</div><div>TIME</div><div>ABSENT</div><div>REASON</div>
  </div>
  <div id="logList"></div>
</div>

<button onclick="resetRecords()">RESET (ADMIN)</button>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { members, TOTAL_MEMBERS } from "./member.js";

const firebaseConfig = {
  apiKey: "AIzaSyC2Qqjc4Z-za60nya2ANMOP6DwQQx5IoE",
  databaseURL: "https://attendance-f8237-default-rtdb.firebaseio.com"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const dateInput = document.getElementById("date");
const timeInput = document.getElementById("time");

setInterval(()=>{
  const now = new Date();
  dateInput.value = now.toISOString().slice(0,10);
  timeInput.value = now.toTimeString().slice(0,8);
},1000);

window.confirmEntry = function(){
  const name = nameInput.value.trim();
  const cpm = cpmInput.value.trim();

  const valid = members.find(m=>m.name.toLowerCase()===name.toLowerCase() && m.cpm===cpm);
  if(!valid) return alert("You are NOT a member");

  push(ref(db,"attendance"),{
    name,cpm,
    date:dateInput.value,
    time:timeInput.value,
    absent:absent.value.toUpperCase()||"NO",
    reason:reason.value
  });

  nameInput.value=cpmInput.value=absent.value=reason.value="";
};

const logList = document.getElementById("logList");
const absentList = document.getElementById("absentList");
const countDisplay = document.getElementById("countDisplay");
const rateDisplay = document.getElementById("rateDisplay");
const progressBar = document.getElementById("progressBar");

onValue(ref(db,"attendance"), snap=>{
  logList.innerHTML="";
  absentList.innerHTML="";

  const records = Object.values(snap.val()||{});
  const present = new Set(records.filter(r=>r.absent!=="YES").map(r=>r.cpm));
  const presentCount = present.size;

  countDisplay.innerText = `${presentCount} / ${TOTAL_MEMBERS} Members`;

  let rate="BAD";
  if(presentCount===TOTAL_MEMBERS) rate="COMPLETE ðŸŽ‰";
  else if(presentCount>=TOTAL_MEMBERS*0.9) rate="VERY GOOD";
  else if(presentCount>=TOTAL_MEMBERS*0.7) rate="GOOD";
  rateDisplay.innerText=rate;

  const percent = (presentCount / TOTAL_MEMBERS) * 100;
  progressBar.style.width = percent+"%";
  progressBar.className="";
  progressBar.classList.add(
    rate==="BAD"?"bar-bad":
    rate==="GOOD"?"bar-good":
    rate==="VERY GOOD"?"bar-very-good":"bar-complete"
  );

  members.forEach(m=>{
    if(!present.has(m.cpm)){
      const li=document.createElement("li");
      li.textContent=`${m.name} (${m.cpm})`;
      absentList.appendChild(li);
    }
  });

  records.reverse().forEach(r=>{
    const row=document.createElement("div");
    row.className="log-row";
    row.innerHTML=`
      <div class="status ${r.absent==="YES"?"absent":"present"}"></div>
      <div>${r.name}</div><div>${r.cpm}</div>
      <div>${r.date}</div><div>${r.time}</div>
      <div>${r.absent}</div><div>${r.reason||""}</div>`;
    logList.appendChild(row);
  });
});

window.resetRecords=function(){
  if(prompt("Password")!=="cris123")return;
  remove(ref(db,"attendance"));
};
</script>

</body>
</html>
